---
title: "07-logistic_regression"
author: "Katherine Goode"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, eval = TRUE)
```

# Overview

I have been thinking a lot about it is difficult to determine whether LIME is providing reasonable explanations, because we cannot know what the random forest is doing. That is the point of LIME. Heike suggested that we fit a logistic regression model to the training bullet data. We can then apply LIME to the logistic regression and determine if the explanations match what we would expect based on the coefficients of the logistic regression that we can interpret. She also suggested including interactions in the logistic regression model. This journal goes through the process of fitting several logisitic regression models, applying LIME to them, and comparing the results.

```{r}
# Load libraries
library(lime)
library(tidyverse)
```

# The Data

The cleaned training and testing datasets are loaded in below.

```{r}
# Load in the training data (Hamby Data 173 and 252)
hamby173and252_train <- read.csv("../../data/hamby173and252_train.csv")

# Load in the testing data (Hamby Data 224 Sets 1 and 11)
hamby224_test <- read.csv("../../data/hamby224_test.csv")
```

A vector containing the features used in the random forest `rtrees` is created below that will be used when creating some of the plots in this journal.

```{r}
# Obtain features used when fitting the rtrees random forest
rf_features <- rownames(bulletr::rtrees$importance)
```

# Logistic Regression Models

### Main Effects Only

The code below fits a logistic regression model to the training data using the `train` function from the caret package. The nine features used to fit `rtrees` are included as main effects only. The features are standardized prior to fitting the model using the `preProcess = "scale"` in `train`.

```{r}
# Fit or load the logistic regression model with only main effects
if(!file.exists("../../data/logistic_mains.rds")) {
  
  # Fit the model
  logistic_mains <- caret::train(as.factor(samesource) ~ ccf + rough_cor + D + sd_D + 
                                   matches + mismatches + cms + non_cms + sum_peaks,
                                 preProcess = "scale",
                                 data = hamby173and252_train, 
                                 method = "glm", 
                                 family = "binomial")

  # Save the model
  saveRDS(logistic_mains, "../../data/logistic_mains.rds")

} else{
  
  # Load the model
  logistic_mains <- readRDS("../../data/logistic_mains.rds")
  
}
```

The output from the model is shown below. The features of ccf and matches stand out as the most important features in the model.

```{r}
# Summary of the model
summary(logistic_mains)
```

### All Two Way Interactions

The code below fits a logistic regression model to the training data using the `train` function from the caret package. The nine features used to fit `rtrees` are included as main effects and with all two way interactions. The features are standardized prior to fitting the model using the `preProcess = "scale"` in `train`.

```{r}
# Fit or load the logistic regression model with all two way interactions
if(!file.exists("../../data/logistic_inters2.rds")) {
  
  # Fit the model
  logistic_inters2 <- caret::train(as.factor(samesource) ~
                                       (ccf + rough_cor + D + sd_D + matches + 
                                          mismatches + cms + non_cms + sum_peaks)^2,
                                     preProcess = "scale",
                                     data = hamby173and252_train,
                                     method = "glm", 
                                     family = "binomial")
  
  # Save the model
  saveRDS(logistic_inters2, "../../data/logistic_inters2.rds")

} else{
  
   # Load the model
  logistic_inters2 <- readRDS("../../data/logistic_inters2.rds")
  
}
```

The output from the model is shown below.

```{r}
# Summary of the model
summary(logistic_inters2)
```

### All Three Way Interactions

The code below fits a logistic regression model to the training data using the `train` function from the caret package. The nine features used to fit `rtrees` are included as main effects and with all two and three way interactions. The features are standardized prior to fitting the model using the `preProcess = "scale"` in `train`.

```{r eval = FALSE}
# Fit or load the logistic regression model with all two and three way interactions
if(!file.exists("../../data/logistic_inters3.rds")) {
  
  # Fit the model
  logistic_inters3 <- caret::train(as.factor(samesource) ~
                                       (ccf + rough_cor + D + sd_D + matches + 
                                          mismatches + cms + non_cms + sum_peaks)^3,
                                     preProcess = "scale",
                                     data = hamby173and252_train,
                                     method = "glm", 
                                     family = "binomial")
  
  # Save the model
  saveRDS(logistic_inters3, "../../data/logistic_inters3.rds")

} else{
  
  # Load the model
  logistic_inters3 <- readRDS("../../data/logistic_inters3.rds")
  
}
```

The output from the model is shown below.

```{r eval = FALSE}
# Summary of the model
summary(logistic_inters3)
```

### Comparing the Logistic Models


# Applying LIME to the Models

### Main Effects Only

```{r eval = FALSE}
logistic_mains_lime <- lime(x = hamby173and252_train %>% select(rf_features), 
                            model = logistic_mains$finalModel)

logistic_mains_explain <- explain(x = hamby224_test %>% 
                                    select(rf_features) %>% 
                                    na.omit(), 
                                  explainer = logistic_mains_lime, 
                                  n_labels = 1,
                                  n_features = 3)

plot_features(logistic_mains_explain[1:12,])
```

### All Two Way Interactions

```{r eval = FALSE}
logistic_inters2_lime <- lime(x = hamby173and252_train %>% select(rf_features), 
                              model = logistic_inters2)

logistic_inters2_explain <- explain(x = hamby224_test %>% 
                                      select(rf_features) %>% 
                                      na.omit(), 
                                    explainer = logistic_inters2_lime, 
                                    n_labels = 1,
                                    n_features = 3)

plot_features(logistic_inters2_explain[1:12,])
```

### All Three Way Interactions

```{r eval = FALSE}
logistic_inters3_lime <- lime(x = hamby173and252_train %>% select(rf_features), 
                              model = logistic_inters3)

logistic_inters3_explain <- explain(x = hamby224_test %>% 
                                      select(rf_features) %>% 
                                      na.omit(), 
                                    explainer = logistic_inters3_lime, 
                                    n_labels = 1,
                                    n_features = 3)

plot_features(logistic_inters3_explain[1:12,])
```

# Session Info

```{r}
sessionInfo()
```
